name: Check New Release

on:
  schedule:
    - cron: "14 */4 * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: fregante/setup-git-user@v1

      - name: Fetch latest release (including pre-release)
        id: fetch
        run: |
          curl -H "authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -sfL -m 60 ${{ github.api_url }}/repos/telegramdesktop/tdesktop/releases | jq -r '[.[] | select(.draft == false)][0].tag_name' > /tmp/latest_tag
          echo ::set-output name=latest_tag::"$(cat /tmp/latest_tag)"

      - name: Check if branch exists
        id: check-branch
        run: |
          http_code=$(curl -H "authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -sL -m 60 -o /tmp/branch.json -w "%{http_code}" ${{ github.api_url }}/repos/${{ github.repository }}/branches/"${{ steps.fetch.outputs.latest_tag }}")
          echo http_code="$http_code"
          echo "body=$(cat /tmp/branch.json)"
          branch_not_found=false
          if [[ "$http_code" == '404' && "$(jq -r '.message' /tmp/branch.json)" == 'Branch not found' ]]; then
            branch_not_found=true
          fi
          echo ::set-output name=not_found::"$branch_not_found"

      - name: Checkout new branch if not exists
        if: steps.check-branch.outputs.not_found == 'true'
        run: |
          latest_tag="${{ steps.fetch.outputs.latest_tag }}"
          git remote add upstream https://github.com/telegramdesktop/tdesktop.git
          git fetch upstream
          git fetch --unshallow origin
          git checkout "refs/tags/$latest_tag"
          git checkout -b "$latest_tag"
          find .github/workflows/ -type f ! -name win.yml -delete
          git commit -am "Remove all workflows except win.yml"
          git cherry-pick 905ef082..5b6946d6
      
      - name: Push to branch if not exists
        if: steps.check-branch.outputs.not_found == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GH_PAT }}
          branch: ${{ steps.fetch.outputs.latest_tag }}
